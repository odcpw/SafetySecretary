# Localization (i18n)

## Goals
- Support EN/FR/DE now (Italian later).
- Per-user locale with a Settings selector.
- UI and exports match the selected language.
- Backend error messages remain English (UI handles user-facing messaging).

## Frontend architecture
- Provider: `frontend/src/i18n/I18nContext.tsx`
  - `I18nProvider` stores locale in `localStorage` (`ss_locale`) and sets `document.lang`.
  - `useI18n()` exposes `t`, `formatDate`, `formatDateTime`, `formatNumber`.
- Strings live in `frontend/src/i18n/translations.ts` and use dot keys:
  - Example: `t("ra.hazards.confirmDelete")`
  - Use `fallback` for dynamic values that already provide user-facing labels.
- Per-user locale is synced on login + Settings:
  - `POST /api/auth/login` returns user locale
  - `PATCH /api/auth/me/locale` persists per-user locale in registry

## Backend exports (PDF/XLSX)
- Export translations live in `src/services/reportTranslations.ts`.
- `ReportService` builds a translator via `createReportTranslator(locale)` and uses it for:
  - PDF labels and section headings
  - XLSX sheet names, headers, and guidance text
  - Risk band labels, incident types, action status labels
- Export routes pass the user locale from `req.auth.locale`:
  - `src/routes/raCasesRouter.ts`
  - `src/routes/jhaCasesRouter.ts`
  - `src/routes/incidentCasesRouter.ts`

## Key conventions
- `common.*` for shared UI verbs and nouns.
- `landing.*` for landing pages.
- `ra.*`, `jha.*`, `incident.*` for domain screens.
- `domain.*` for enums and categories.
- Avoid mixing label strings with nested objects (e.g., use `statusLabel` and `status.*`).

## Inventory (high level)
- Login + session UX: `auth.*`, `banners.*`, `menu.*`
- Home landing tiles: `landing.home.*`
- HIRA landing + editor: `landing.hira.*`, `ra.*`, `phases.*`, `domain.*`
- JHA landing + editor: `landing.jha.*`, `jha.*`
- Incident landing + editor: `landing.incident.*`, `incident.*`
- Admin portal: `admin.*`
- Settings + user menu: `menu.*`, `theme.*`, `focus.*`

## Adding a new string
1. Add the key to `frontend/src/i18n/translations.ts` in EN/FR/DE.
2. Replace the hardcoded string with `t("...")`.
3. If used in tests, wrap rendering with `I18nProvider`.
4. For exports, add the string to `src/services/reportTranslations.ts`.

## QA checklist
- Switch language in user menu and verify:
  - Landing pages
  - HIRA/JHA/Incident editors
  - Settings and admin portal
- Export PDF/XLSX in each locale and confirm:
  - Headers, section titles, and guidance are localized
  - Dates format with locale conventions
- Check for fallback keys in UI (key name rendered).

## Planned next steps
- Add `it` locale (Italian).
- Consider localized LLM output once model strategy is defined.
