// Prisma schema for SafetySecretary backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Phase progression for HIRA workflow
enum RiskAssessmentPhase {
  PROCESS_STEPS         // 1. Describe process: activity + equipment + substances
  HAZARD_IDENTIFICATION // 2. Identify hazards per step + existing controls
  RISK_RATING           // 3. Baseline risk assessment (adherence to existing controls)
  CONTROL_DISCUSSION    // 4. Discuss possible additional controls
  ACTIONS               // 5. Structure controls into action plan
  RESIDUAL_RISK         // 6. Rate risk after proposed controls
  COMPLETE              // Final state
}

enum ActionStatus {
  OPEN
  IN_PROGRESS
  COMPLETE
}

enum HazardAssessmentType {
  BASELINE
  RESIDUAL
}

// S-T-O-P control hierarchy (effectiveness: high to low)
enum ControlHierarchy {
  SUBSTITUTION    // S - Replace the hazard entirely
  TECHNICAL       // T - Engineering controls (guards, ventilation, barriers)
  ORGANIZATIONAL  // O - Procedures, training, supervision
  PPE             // P - Personal protective equipment (last resort)
}

enum IncidentType {
  NEAR_MISS
  FIRST_AID
  LOST_TIME
  PROPERTY_DAMAGE
}

enum IncidentTimelineConfidence {
  CONFIRMED
  LIKELY
  UNCLEAR
}

enum IncidentActionType {
  ENGINEERING
  ORGANISATIONAL
  PPE
  TRAINING
}

model RiskAssessmentCase {
  id            String         @id @default(uuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  activityName  String
  location      String?
  team          String?
  phase         RiskAssessmentPhase @default(PROCESS_STEPS)

  steps         ProcessStep[]
  hazards       Hazard[]
  actions       CorrectiveAction[]
  attachments   Attachment[]
}

// Process step with HIRA triad: activity + equipment + substances
model ProcessStep {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  caseId      String
  orderIndex  Int

  // HIRA triad fields
  activity    String              // What is being done (main action/task)
  equipment   String[]            // Tools/machines used
  substances  String[]            // Materials/chemicals involved
  description String?             // Additional context

  raCase      RiskAssessmentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  hazards     Hazard[]
  attachments Attachment[]

  @@index([caseId])
}

// Hazard with category classification and existing controls
model Hazard {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  caseId      String
  stepId      String
  orderIndex  Int                    @default(0)
  label       String                 // Human-readable hazard name
  description String?                // What can happen / past incidents
  categoryCode String?               // Category code (e.g., "MECHANICAL", "FALLS")

  // Existing controls captured during hazard identification phase
  existingControls String[]          // Rules/controls already in place

  raCase           RiskAssessmentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  step             ProcessStep       @relation(fields: [stepId], references: [id], onDelete: Cascade)
  actions          CorrectiveAction[]
  assessments      HazardAssessment[]
  proposedControls HazardControl[]    // NEW controls from discussion phase
  attachments      Attachment[]

  @@index([caseId])
  @@index([stepId, orderIndex])
}

model CorrectiveAction {
  id          String      @id @default(uuid())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  caseId      String
  hazardId    String?
  controlId   String?
  orderIndex  Int         @default(0)
  description String
  owner       String?
  dueDate     DateTime?
  status      ActionStatus @default(OPEN)

  raCase      RiskAssessmentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  hazard      Hazard?            @relation(fields: [hazardId], references: [id], onDelete: SetNull)
  control     HazardControl?     @relation(fields: [controlId], references: [id], onDelete: SetNull)

  @@index([caseId])
  @@index([hazardId])
  @@index([controlId])
  @@unique([controlId])
}

model HazardAssessment {
  id         String               @id @default(uuid())
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  hazardId   String
  type       HazardAssessmentType
  severity   String
  likelihood String
  riskRating String

  hazard Hazard @relation(fields: [hazardId], references: [id], onDelete: Cascade)

  @@unique([hazardId, type])
}

// Proposed controls from control discussion phase (not existing controls)
model HazardControl {
  id          String             @id @default(uuid())
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  hazardId    String
  description String             @db.Text
  hierarchy   ControlHierarchy?  // S-T-O-P classification

  hazard Hazard @relation(fields: [hazardId], references: [id], onDelete: Cascade)
  actions CorrectiveAction[]

  @@index([hazardId])
}

model Attachment {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  caseId       String
  stepId       String?
  hazardId     String?
  orderIndex   Int      @default(0)
  originalName String
  mimeType     String
  byteSize     Int
  storageKey   String

  raCase       RiskAssessmentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  step         ProcessStep?       @relation(fields: [stepId], references: [id], onDelete: Cascade)
  hazard       Hazard?            @relation(fields: [hazardId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([stepId])
  @@index([hazardId])
}

model JhaCase {
  id              String         @id @default(uuid())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?
  jobTitle        String
  site            String?
  supervisor      String?
  workersInvolved String?
  jobDate         DateTime?
  revision        String?
  preparedBy      String?
  reviewedBy      String?
  approvedBy      String?
  signoffDate     DateTime?
  workflowStage   String   @default("steps")

  steps           JhaStep[]
  hazards         JhaHazard[]
  attachments     JhaAttachment[]
}

model JhaStep {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  caseId     String
  orderIndex Int
  label      String

  jhaCase    JhaCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  hazards    JhaHazard[]
  attachments JhaAttachment[]

  @@index([caseId])
}

model JhaHazard {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  caseId      String
  stepId      String
  orderIndex  Int      @default(0)
  hazard      String
  consequence String?
  controls    String[]

  jhaCase     JhaCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  step        JhaStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  attachments JhaAttachment[]

  @@index([caseId])
  @@index([stepId, orderIndex])
}

model JhaAttachment {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  caseId       String
  stepId       String?
  hazardId     String?
  orderIndex   Int      @default(0)
  originalName String
  mimeType     String
  byteSize     Int
  storageKey   String

  jhaCase      JhaCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  step         JhaStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  hazard       JhaHazard? @relation(fields: [hazardId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([stepId])
  @@index([hazardId])
}

model IncidentCase {
  id                String        @id @default(uuid())
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  createdBy         String?
  title             String
  workflowStage     String        @default("facts")
  incidentAt        DateTime?
  incidentTimeNote  String?
  location          String?
  incidentType      IncidentType
  coordinatorRole   String
  coordinatorName   String?
  assistantNarrative String?
  assistantDraft     Json?
  assistantDraftUpdatedAt DateTime?

  persons           IncidentPerson[]
  accounts          IncidentAccount[]
  timelineEvents    IncidentTimelineEvent[]
  deviations        IncidentDeviation[]
  causeNodes        IncidentCauseNode[]
  attachments       IncidentAttachment[]
}

model IncidentPerson {
  id        String        @id @default(uuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  caseId    String
  role      String
  name      String?
  otherInfo String?

  incidentCase IncidentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  accounts     IncidentAccount[]

  @@index([caseId])
}

model IncidentAccount {
  id           String        @id @default(uuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  caseId       String
  personId     String
  rawStatement String?

  incidentCase IncidentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  person       IncidentPerson @relation(fields: [personId], references: [id], onDelete: Cascade)
  facts        IncidentFact[]
  personalEvents IncidentPersonalEvent[]
  sources      IncidentTimelineSource[]

  @@index([caseId])
  @@index([personId])
}

model IncidentFact {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  accountId String
  orderIndex Int
  text      String

  account   IncidentAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sources   IncidentTimelineSource[]

  @@index([accountId])
}

model IncidentPersonalEvent {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  accountId String
  orderIndex Int
  eventAt   DateTime?
  timeLabel String?
  text      String

  account   IncidentAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sources   IncidentTimelineSource[]

  @@index([accountId])
}

model IncidentTimelineEvent {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  caseId     String
  orderIndex Int
  eventAt    DateTime?
  timeLabel  String?
  text       String
  confidence IncidentTimelineConfidence @default(LIKELY)

  incidentCase IncidentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  sources      IncidentTimelineSource[]
  deviations   IncidentDeviation[]
  causeNodes   IncidentCauseNode[]
  attachments  IncidentAttachment[]

  @@index([caseId])
}

model IncidentTimelineSource {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  timelineEventId String
  accountId       String
  factId          String?
  personalEventId String?

  timelineEvent IncidentTimelineEvent @relation(fields: [timelineEventId], references: [id], onDelete: Cascade)
  account       IncidentAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  fact          IncidentFact?          @relation(fields: [factId], references: [id], onDelete: SetNull)
  personalEvent IncidentPersonalEvent? @relation(fields: [personalEventId], references: [id], onDelete: SetNull)

  @@index([timelineEventId])
  @@index([accountId])
  @@index([factId])
  @@index([personalEventId])
}

model IncidentDeviation {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  caseId          String
  timelineEventId String?
  orderIndex      Int
  expected        String?
  actual          String?
  changeObserved  String?

  incidentCase IncidentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  timelineEvent IncidentTimelineEvent? @relation(fields: [timelineEventId], references: [id], onDelete: SetNull)
  causes       IncidentCause[]

  @@index([caseId])
  @@index([timelineEventId])
}

model IncidentCause {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deviationId String
  orderIndex Int
  statement  String

  deviation IncidentDeviation @relation(fields: [deviationId], references: [id], onDelete: Cascade)
  actions   IncidentAction[]

  @@index([deviationId])
}

model IncidentCauseNode {
  id             String   @id @default(uuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  caseId         String
  parentId       String?
  timelineEventId String?
  orderIndex     Int      @default(0)
  statement      String
  question       String?
  isRootCause    Boolean  @default(false)

  incidentCase   IncidentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  parent         IncidentCauseNode? @relation("IncidentCauseTree", fields: [parentId], references: [id], onDelete: Cascade)
  children       IncidentCauseNode[] @relation("IncidentCauseTree")
  timelineEvent  IncidentTimelineEvent? @relation(fields: [timelineEventId], references: [id], onDelete: SetNull)
  actions        IncidentCauseAction[]

  @@index([caseId])
  @@index([parentId])
  @@index([timelineEventId])
}

model IncidentCauseAction {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  causeNodeId String
  orderIndex  Int      @default(0)
  description String
  ownerRole   String?
  dueDate     DateTime?
  actionType  IncidentActionType?

  causeNode IncidentCauseNode @relation(fields: [causeNodeId], references: [id], onDelete: Cascade)

  @@index([causeNodeId])
}

model IncidentAction {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  causeId    String
  orderIndex Int
  description String
  ownerRole  String?
  dueDate    DateTime?
  actionType IncidentActionType?

  cause IncidentCause @relation(fields: [causeId], references: [id], onDelete: Cascade)

  @@index([causeId])
}

model IncidentAttachment {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  caseId       String
  timelineEventId String?
  orderIndex   Int      @default(0)
  originalName String
  mimeType     String
  byteSize     Int
  storageKey   String

  incidentCase  IncidentCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  timelineEvent IncidentTimelineEvent? @relation(fields: [timelineEventId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([timelineEventId])
}
